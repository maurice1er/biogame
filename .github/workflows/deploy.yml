name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.LIGHTSAIL_PUBLIC_IP }} >> ~/.ssh/known_hosts
      env:
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}

    - name: Copy files to Lightsail instance
      run: |
        ls -la
        pwd
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r ./* ${{ secrets.LIGHTSAIL_USERNAME }}@${{ secrets.LIGHTSAIL_PUBLIC_IP }}:/home/bitnami/plantio
        touch ./.env
        echo "MONGODB_URI=${{ secrets.APP_MONGODB_URI }}" >> ./.env
        echo "PORT=${{ secrets.APP_PORT }}" >> ./.env
        echo "RANDOM_QUESTIONS=${{ secrets.APP_RANDOM_QUESTIONS }}" >> ./.env
        echo "JWT_TOKEN_SECRET=${{ secrets.APP_JWT_SECRET }}" >> ./.env
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r ./.env ${{ secrets.LIGHTSAIL_USERNAME }}@${{ secrets.LIGHTSAIL_PUBLIC_IP }}:/home/bitnami/plantio
        ls -la       
      env:
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        LIGHTSAIL_USERNAME: ${{ secrets.LIGHTSAIL_USERNAME }}
        LIGHTSAIL_PUBLIC_IP: ${{ secrets.LIGHTSAIL_PUBLIC_IP }}
        APP_MONGODB_URI: ${{ secrets.APP_MONGODB_URI }}
        APP_PORT: ${{ secrets.APP_PORT }}
        APP_RANDOM_QUESTIONS: ${{ secrets.APP_RANDOM_QUESTIONS }}
        APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}


    - name: SSH into Lightsail instance and deploy
      run: |
        touch myperm.pem
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > myperm.pem
        chmod 600 myperm.pem
        ssh -i myperm.pem ${{ secrets.LIGHTSAIL_USERNAME }}@${{ secrets.LIGHTSAIL_PUBLIC_IP }} 'cd /home/bitnami/plantio && npm install && npm start'
      env:
        LIGHTSAIL_SSH_KEY: ${{ secrets.LIGHTSAIL_SSH_KEY }}
        LIGHTSAIL_USERNAME: ${{ secrets.LIGHTSAIL_USERNAME }}
        LIGHTSAIL_PUBLIC_IP: ${{ secrets.LIGHTSAIL_PUBLIC_IP }}
        APP_MONGODB_URI: ${{ secrets.APP_MONGODB_URI }}
        APP_PORT: ${{ secrets.APP_PORT }}
        APP_RANDOM_QUESTIONS: ${{ secrets.APP_RANDOM_QUESTIONS }}
        APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}


